<!-- index.html -->
{% load static %} 

<!DOCTYPE html>
<html>
    <head>
        <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
        <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
        <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
        <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

        <title>My TV Time</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" type="text/css" href="{% static 'mytvtime/css/style.css' %}">
    </head>
    <body class="body-home-page">
        <!-- <h1 class="h1-home">My TV Time</h1> -->
        <div id="url-data" style="display: none;"
            data-logout-url="{% url 'mytvtime:logout' %}"
            data-login-url="{% url 'mytvtime:login' %}"
            data-register-url="{% url 'mytvtime:register' %}"
            data-search-results-url="{% url 'mytvtime:search_results' %}">
        </div>
        <div class="user-actions">
            {% if request.user.is_authenticated %}
                <span>Welcome, {{ request.user.username }}</span>
                <a href="javascript:void(0);" onclick="handleLogout()">Logout</a>
            {% else %}
                <a href="{% url 'mytvtime:login' %}">Login</a>
                <a href="{% url 'mytvtime:register' %}">Register</a>
            {% endif %}
        </div>
        <div id="auth-status" style="display: none;">{% if request.user.is_authenticated %}true{% else %}false{% endif %}</div>
        <form class="search-box" action="{% url 'mytvtime:search_results' %}" method="post">
            {% csrf_token %}
            <input type="text" name="search_query" placeholder="Search for a TV show" autocomplete="off">
            <button type="submit">Search</button>
        </form>
        
        {% verbatim %}
        <div id="root"></div>
        <script>
            function handleLogout() {
                const urlDataElement = document.getElementById('url-data');
                const logoutUrl = urlDataElement.getAttribute('data-logout-url');
                sessionStorage.removeItem("shows");
                localStorage.removeItem('watchingShowsData');
                localStorage.removeItem('watchingShowsTime');
                
                window.location.href = logoutUrl;
            }
        </script> 
        <script type="text/babel">
            class WatchingShows extends React.Component {
                constructor(props) {
                    super(props);
                    this.state = {
                        watchingShows: [],
                        isLoading: true,
                        isAuthenticated: false,
                    };
                    this.countdownInterval = null; //store the countdown interval
                }

                componentDidMount() {
                    const urlDataElement = document.getElementById('url-data');
                    const loginUrl = urlDataElement.getAttribute('data-login-url');
                    const registerUrl = urlDataElement.getAttribute('data-register-url');
                    const searchResultsUrl = urlDataElement.getAttribute('data-search-results-url');
                    const authStatusElement = document.getElementById('auth-status');
                    const isAuthenticated = authStatusElement.textContent === 'true';

                    this.setState({ 
                        loginUrl,
                        registerUrl,
                        searchResultsUrl,
                        isAuthenticated: isAuthenticated });

                    if (!isAuthenticated) {
                        this.setState({ isLoading: false });
                        return;
                    }


                    axios.get('/get_watching_shows/')
                        .then(res => {
                            console.log(res.data);
                            const watchingShows = res.data.watching_shows ? res.data.watching_shows.sort((a, b) => {
                                const minutesUntilNextEpisodeA = a.days * 24 * 60 + a.hours * 60 + a.minutes;
                                const minutesUntilNextEpisodeB = b.days * 24 * 60 + b.hours * 60 + b.minutes;
                                return (minutesUntilNextEpisodeA || Infinity) - (minutesUntilNextEpisodeB || Infinity);
                            }) : [];

                            // add countdown to each show
                            for (const show of watchingShows) {
                                show.countdown = {
                                    days: show.days,
                                    hours: show.hours,
                                    minutes: show.minutes
                                };
                            }

                            this.setState({
                                watchingShows,
                                isLoading: false,
                            });

                            // start the countdown interval
                            this.countdownInterval = setInterval(this.updateCountdowns, 60000);
                        })
                        .catch(error => {
                            console.error(error);
                            this.setState({
                                isLoading: false,
                                hasError: true,
                            });
                        });
                }
                componentWillUnmount() {
                    // clear the countdown interval
                    if (this.countdownInterval) {
                        clearInterval(this.countdownInterval);
                        this.countdownInterval = null;
                    }
                }
                
                // update countdowns
                updateCountdowns = () => {
                    this.setState(prevState => {
                        const watchingShows = [...prevState.watchingShows];
                        for (const show of watchingShows) {
                            if (show.countdown) {
                                if (show.countdown.minutes && show.countdown.minutes > 0) {
                                    show.countdown.minutes--;
                                } else if (show.countdown.hours && show.countdown.hours > 0) {
                                    show.countdown.hours--;
                                    show.countdown.minutes = 59;
                                } else if (show.countdown.days && show.countdown.days > 0) {
                                    show.countdown.days--;
                                    show.countdown.hours = 23;
                                    show.countdown.minutes = 59;
                                } else {
                                    show.countdown.days = null;
                                    show.countdown.hours = null;
                                    show.countdown.minutes = null;
                                }
                            }

                        }
                        return { watchingShows };
                    });
                };
                            
                handleDelete(id) {
                    let csrftoken = getCookie('csrftoken');
                    function getCookie(name) {
                        let cookieValue = null;
                        if (document.cookie && document.cookie !== '') {
                            const cookies = document.cookie.split(';');
                            for (let i = 0; i < cookies.length; i++) {
                                const cookie = cookies[i].trim();
                                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                    break;
                                }
                            }
                        }
                        return cookieValue;
                    }

                    axios({
                        method: 'post',
                        url: '/remove_from_watchlist/',
                        data: {
                            trakt_id: id
                        },
                        headers: {"X-CSRFToken": csrftoken}
                    }).then(res => {
                        if (res.data.status === 'success') {
                            this.setState(prevState => ({
                                watchingShows: prevState.watchingShows.filter(show => show.trakt !== id)
                            }), () => {
                                localStorage.setItem('watchingShowsData', JSON.stringify(this.state.watchingShows));
                            });
                        } else {
                            alert('Could not delete show');
                        }
                    });
                }

                handleUpdate() {
                    axios.get('/update_user_watchlist/')
                        .then(res => {
                            if (res.data.status === 'success') {
                                this.componentDidMount();
                            } else {
                                alert('Could not update database');
                            }
                        });
                }

                render() {
                    if (this.state.isLoading) {
                        return (
                            <div>
                                <p>Loading...</p>
                            </div>
                        );
                    } 

                    if (!this.state.isAuthenticated) {
                        return (
                            <div class="user-login-prompt">
                                <p>You must be logged in to see your list of shows.</p>
                                <p><a href={this.state.loginUrl}>Log in</a> or <a href={this.state.registerUrl}>Register</a> now.</p>
                            </div>
                        );
                    }
                    if (this.state.isAuthenticated) {
                        return (
                            <div className="watching-show-list-container">
                                <ul className="watching-show-list">
                                    {this.state.watchingShows.map(show =>
                                        <li key={show.title} className="watching-show-item" style={{
                                            backgroundImage: show.poster_url ? `url(${show.poster_url})` : 'none'}}>
                                            <h2>{show.title}</h2>
                                            {show.countdown.days != null && show.countdown.hours != null && show.countdown.minutes != null ? (
                                                <div>
                                                    <p className="show-season">S{show.season} E{show.episode}</p>
                                                    {show.countdown ? 
                                                    (<div className="countdown">
                                                        <ul>
                                                            <li><span>{show.countdown.days}</span>Days</li>
                                                            <li><span>{show.countdown.hours}</span>Hours</li>
                                                            <li><span>{show.countdown.minutes}</span>Minutes</li>
                                                        </ul>
                                                    </div>): null}
                                                </div>
                                            ) : (
                                                <div>
                                                    <p className="show-status">{show.status}</p>
                                                </div>
                                            )}
                                            <button className="delete-button" onClick={() => this.handleDelete(show.trakt)}>Delete</button>
                                        </li>
                                    )}
                                </ul>
                                <button className="update-database-button" onClick={() => this.handleUpdate()}>Refresh List</button>
                            </div>
                        );
                    }
                }
            }

            ReactDOM.render(
                <WatchingShows />,
                document.getElementById('root')
            );
        </script>
        {% endverbatim %}
    </body>
</html>

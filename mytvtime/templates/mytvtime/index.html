<!-- index.html -->
{% load static %} 
<!DOCTYPE html>
<html lang="en">
    <head>
        <link rel="stylesheet" type="text/css" href="{% static 'mytvtime/css/style.css' %}">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
        <title>My TV Time</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
    </head>
    <body class="body-home-page">
        <!-- <h1 class="h1-home">My TV Time</h1> -->
        <div id="url-data" style="display: none;"
            data-logout-url="{% url 'mytvtime:logout' %}"
            data-login-url="{% url 'mytvtime:login' %}"
            data-register-url="{% url 'mytvtime:register' %}"
            data-search-results-url="{% url 'mytvtime:search_results' %}">
        </div>
        <div class="user-actions">
            {% if request.user.is_authenticated %}
                <span>Welcome, {{ request.user.username }}</span>
                <a href="javascript:void(0);" onclick="handleLogout()">Logout</a>
            {% else %}
                <a href="{% url 'mytvtime:login' %}">Login</a>
                <a href="{% url 'mytvtime:register' %}">Register</a>
            {% endif %}
        </div>
        <div id="auth-status" style="display: none;">{% if request.user.is_authenticated %}true{% else %}false{% endif %}</div>
        <form class="search-box" action="{% url 'mytvtime:search_results' %}" method="post">
            {% csrf_token %}
            <input type="text" name="search_query" placeholder="Search for a TV show" autocomplete="off">
            <button type="submit"><i class="fas fa-search"></i></button>
        </form>

        <!-- React CDN Link -->
        <script defer crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
        <script defer crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
        <script defer src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
        <script defer src="https://unpkg.com/axios/dist/axios.min.js"></script>
        {% verbatim %}
        <div id="app"></div>
        <script>
            function handleLogout() {
                const urlDataElement = document.getElementById('url-data');
                const logoutUrl = urlDataElement.getAttribute('data-logout-url');
                sessionStorage.removeItem("shows");
                localStorage.removeItem('watchingShowsData');
                localStorage.removeItem('watchingShowsTime');
                
                window.location.href = logoutUrl;
            }
        </script> 
        <script type="text/babel">
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            
            function WatchingShows() {
                const [watchingShows, setWatchingShows] = React.useState([]);
                const [isLoading, setIsLoading] = React.useState(true);
                const [isAuthenticated, setIsAuthenticated] = React.useState(false);
                const [isUpdating, setIsUpdating] = React.useState(false);
                const [update, setUpdate] = React.useState(false);
                const [fadeIn, setFadeIn] = React.useState(false);  // New state variable for fade-in effect

                const countdownInterval = React.useRef(null);

                const urlDataElement = document.getElementById('url-data');
                const loginUrl = urlDataElement.getAttribute('data-login-url');
                const registerUrl = urlDataElement.getAttribute('data-register-url');
                const searchResultsUrl = urlDataElement.getAttribute('data-search-results-url');
                const authStatusElement = document.getElementById('auth-status');
                const isAuthenticatedStatus = authStatusElement.textContent === 'true';

                React.useEffect(() => {
                    setIsAuthenticated(isAuthenticatedStatus);

                    if (!isAuthenticatedStatus) {
                        setIsLoading(false);
                        return;
                    }

                    axios.get('/get_watching_shows/')
                        .then(res => {
                            const watchingShows = res.data.watching_shows || [];
                            for (const show of watchingShows) {
                                show.countdown = {
                                    days: show.days,
                                    hours: show.hours,
                                    minutes: show.minutes
                                };
                            }
                            setWatchingShows(watchingShows);
                            setIsLoading(false);

                            // Start the interval
                            countdownInterval.current = setInterval(updateCountdowns, 60000);
                        })
                        .catch(error => {
                            console.error(error);
                            setIsLoading(false);
                        });

                    return () => {
                        if (countdownInterval.current) {
                            clearInterval(countdownInterval.current);
                            countdownInterval.current = null;
                        }
                    };
                }, [update]);

                React.useEffect(() => { //effect hook for fade-in effect
                    setFadeIn(true);
                    const timer = setTimeout(() => {
                        setFadeIn(false);
                    }, 1000);

                    return () => clearTimeout(timer);
                }, []);

                function updateCountdowns() {
                    setWatchingShows(prevWatchingShows => {
                        const newWatchingShows = [...prevWatchingShows];
                        for (const show of newWatchingShows) {
                            if (show.countdown) {
                                if (show.countdown.minutes && show.countdown.minutes > 0) {
                                    show.countdown.minutes--;
                                } else if (show.countdown.hours && show.countdown.hours > 0) {
                                    show.countdown.hours--;
                                    show.countdown.minutes = 59;
                                } else if (show.countdown.days && show.countdown.days > 0) {
                                    show.countdown.days--;
                                    show.countdown.hours = 23;
                                    show.countdown.minutes = 59;
                                } else {
                                    show.countdown.days = null;
                                    show.countdown.hours = null;
                                    show.countdown.minutes = null;
                                }
                            }
                        }
                        return newWatchingShows;
                    });
                }

                function handleDelete(id) {
                    const csrftoken = getCookie('csrftoken');
                    axios({
                        method: 'post',
                        url: '/remove_from_watchlist/',
                        data: {
                            trakt_id: id
                        },
                        headers: {"X-CSRFToken": csrftoken}
                    }).then(res => {
                        if (res.data.status === 'success') {
                            setWatchingShows(prevWatchingShows => {
                                const newWatchingShows = prevWatchingShows.filter(show => show.trakt !== id);
                                localStorage.setItem('watchingShowsData', JSON.stringify(newWatchingShows));
                                return newWatchingShows;
                            });
                        } else {
                            alert('Could not delete show');
                        }
                    });
                }

                function handleUpdate() {
                    setIsUpdating(true);
                    axios.get('/update_user_watchlist/')
                        .then(res => {
                            if (res.data.status === 'success') {
                                setUpdate(prevState => !prevState);
                            } else {
                                alert('Could not update database');
                            }
                        })
                        .finally(() => {
                            setIsUpdating(false);
                        });
                }

                if (isLoading) {
                    return (
                        //empty
                        <div>
                            <p> </p>
                        </div>
                    );
                }

                if (!isAuthenticatedStatus) {
                    return (
                        <div className="user-login-prompt">
                            <p>You must be logged in to see your list of shows.</p>
                            <p><a href={loginUrl}>Log in</a> or <a href={registerUrl}>Register</a> now.</p>
                        </div>
                    );
                }

                if (isAuthenticatedStatus) {
                    return (
                        <div className="watching-show-list-container">
                            <ul className="watching-show-list">
                                {watchingShows.map((show, index) =>
                                    <li key={show.trakt} className={`watching-show-item fade-in`} style={{animationDelay: `${index * 0.1}s`}}>
                                        <div className="watching-show-list-item-background" style={{
                                            backgroundImage: show.poster_url ? `url(${show.poster_url})` : 'none'}}>
                                        </div>
                                        <div className="watching-show-list-item-content">
                                            <h2>{show.title}</h2>
                                            {show.countdown.days != null && show.countdown.hours != null && show.countdown.minutes != null ? (
                                                <>
                                                    <p className="show-season">S{show.season} E{show.episode}</p>
                                                    {show.countdown ? 
                                                    (<div className="countdown">
                                                        <ul>
                                                            <li><span>{show.countdown.days}</span>Days</li>
                                                            <li><span>{show.countdown.hours}</span>Hours</li>
                                                            <li><span>{show.countdown.minutes}</span>Minutes</li>
                                                        </ul>
                                                    </div>): null}
                                                </>
                                            ) : (
                                                <>
                                                    <p className="show-status">{show.status}</p>
                                                </>
                                            )}
                                            <button className="delete-button" onClick={() => handleDelete(show.trakt)}>Delete</button>
                                        </div>
                                    </li>
                                )}
                            </ul>
                            <button className="refresh-list-button" onClick={handleUpdate}>
                                <i className={`fas fa-sync-alt refresh-icon ${isUpdating ? 'fa-spin' : ''}`}></i>
                            </button>
                        </div>
                    );
                }
            }

            ReactDOM.render(<WatchingShows />, document.querySelector("#app"));
        </script>
        {% endverbatim %}
    </body>
</html>
